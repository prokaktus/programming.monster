name: Build Docker image

on: [push]
env:
  REPO_URL: docker.pkg.github.com/prokaktus/programming.monster/repository
  GIT_SHA: ${{ github.sha }}

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v1
      - name: Display env
        run: echo $GITHUB_SHA
        shell: bash
      - name:
        uses: elgohr/Publish-Docker-Github-Action@master
        with:
          name: prokaktus/programming.monster/repository
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          registry: docker.pkg.github.com
          dockerfile: 'docker/base/Dockerfile'
          tags: 'latest,${{ github.sha }}'
          cache: true


  tests:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v1
      - name: login
        uses: azure/docker-login@v1
        with:
          login-server: docker.pkg.github.com
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Run tests
        run: docker run $REPO_URL:$GIT_SHA pytest

  lint:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v1
      - name: login
        uses: azure/docker-login@v1
        with:
          login-server: docker.pkg.github.com
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Run linter
        run: docker run $REPO_URL:$GIT_SHA flake8

  deploy:
    runs-on: ubuntu-latest
    needs: [lint, tests]

    steps:
      - uses: actions/checkout@v1
      - name: Run ssh command
        uses: appleboy/ssh-action@master
        env:
          GIT_SHA: ${{ github.sha }}
          DJANGO_ALLOWED_HOSTS: '*'
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          envs: GIT_SHA,DJANGO_ALLOWED_HOSTS
          script_stop: true
          script: |
            docker login docker.pkg.github.com -u ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }}
            cd /root/promonster/
            git fetch
            git checkout ${{ github.sha }}
            docker-compose -f docker-compose.prod.yml up
